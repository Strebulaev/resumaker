<div class="resume-generation-container">
  <h2 class="resume-header">{{ 'RESUME_GENERATION.HEADER' | translate }}</h2>

  <!-- Выбор вакансии -->
  <div class="section-card">
    <h3 class="section-title">{{ 'VACANCY.VACANCY_INFO' | translate }}</h3>

    <div class="vacancy-selection">
      <button pButton
              type="button"
              [label]="'VACANCY_SELECTOR.TITLE' | translate"
              icon="pi pi-briefcase"
              (click)="openVacancySelector()"
              class="p-button-outlined">
      </button>

      <!-- Информация о выбранной вакансии -->
      <div *ngIf="selectedVacancy" class="selected-vacancy">
        <div class="vacancy-info">
          <i [class]="getPlatformIcon(selectedVacancy.platform)" class="platform-icon"></i>
          <span class="vacancy-name">{{ selectedVacancy.name }}</span>
          <span class="platform-label">({{ getPlatformLabel(selectedVacancy.platform) }})</span>
          <span class="employer-name">{{ selectedVacancy.employer?.name }}</span>
        </div>
        <button pButton
                icon="pi pi-times"
                class="p-button-text p-button-danger"
                (click)="clearSelectedVacancy()">
        </button>
      </div>
    </div>
  </div>

  <!-- Поле для сопроводительного письма -->
  <div class="section-card">
    <h3 class="section-title">{{ 'RESUME_GENERATION.COVER_LETTER_OPTIONAL' | translate }}</h3>
    <div class="file-upload-section">
      <label class="cover-letter-label">{{ 'RESUME_GENERATION.COVER_LETTER' | translate }}</label>
      <textarea
        pInputTextarea
        [(ngModel)]="coverLetterContent"
        [ngModelOptions]="{standalone: true}"
        [rows]="5"
        [placeholder]="'RESUME_GENERATION.COVER_LETTER_PLACEHOLDER' | translate"
        class="cover-letter-textarea">
      </textarea>
    </div>

    <div class="file-upload-section">
      <app-translated-file-input
        [accept]="'.txt,.pdf,.doc,.docx,.rtf'"
        [fieldName]="'resume-generation-cover-letter'"
        (fileSelected)="onCoverLetterFileSelect($event)"
        [showFileTypes]="true">
      </app-translated-file-input>

      @if (coverLetterFile) {
        <div class="uploaded-file">
          <span class="file-name">{{ coverLetterFile.name }}</span>
          <button pButton icon="pi pi-times" class="p-button-text p-button-danger"
                  (click)="removeCoverLetterFile()">
          </button>
        </div>
      }
    </div>
    <small class="hint-text">{{ 'RESUME_GENERATION.COVER_LETTER_HINT' | translate }}</small>
  </div>

  <!-- File Attachments Section -->
  <div class="section-card">
    <h3 class="section-title">{{ 'RESUME_GENERATION.ATTACHMENTS' | translate }}</h3>
    <div>
      <small class="attachments-hint">{{ 'RESUME_GENERATION.ATTACHMENTS_HINT' | translate }}</small>
    </div>

    <div class="file-input-wrapper">
      <app-translated-file-input
        [accept]="'.pdf,.doc,.docx,.txt,.jpg,.jpeg,.png'"
        [fieldName]="'resume-attachments'"
        [multiple]="true"
        (filesSelected)="onAttachmentsSelected($event)"
        [showFileTypes]="true">
      </app-translated-file-input>
    </div>

    <!-- Attached Files List -->
    <div *ngIf="attachedFiles.length > 0" class="attached-files-list">
      <h4 class="files-title">{{ 'RESUME_GENERATION.ATTACHED_FILES' | translate }} ({{ attachedFiles.length }})</h4>
      <div class="files-container">
        <div class="file-item" *ngFor="let file of attachedFiles; let i = index; trackBy: trackByFile">
          <div class="file-info">
            <i [class]="getFileIcon(file.type)" class="file-icon"></i>
            <div class="file-details">
              <span class="file-name">{{ file.name }}</span>
              <span class="file-meta">{{ getFileSize(file.size) }} • {{ getFileTypeLabel(file.type) }}</span>
            </div>
          </div>
          <div class="file-actions">
            <button pButton icon="pi pi-eye" class="p-button-text p-button-sm"
                    (click)="previewFile(file)"
                    [pTooltip]="'PREVIEW' | translate">
            </button>
            <button pButton icon="pi pi-times" class="p-button-text p-button-danger p-button-sm"
                    (click)="removeAttachment(i)"
                    [pTooltip]="'REMOVE' | translate">
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Кнопка генерации -->
  <div class="generate-button-section">
    <button pButton
            (click)="generateResume()"
            [disabled]="isLoading"
            class="generate-button"
            icon="pi pi-file">
      @if (isLoading) {
        {{ 'BUTTON.RESUME_GENERATION_IN_PROCESS' | translate }}
      } @else {
        {{ 'BUTTON.GENERATE_RESUME' | translate }}
      }
    </button>
  </div>

  <!-- Действия с результатом -->
  @if (generatedResume) {
    <div class="actions-section">
      <button pButton
              (click)="saveResume()"
              [disabled]="isLoading"
              class="action-button save-button"
              icon="pi pi-save">
        {{ 'BUTTON.SAVE' | translate }}
      </button>

      <button pButton
              (click)="deleteResume()"
              [disabled]="isLoading"
              class="action-button delete-button"
              icon="pi pi-trash">
        {{ 'BUTTON.DELETE' | translate }}
      </button>

      <button pButton
              (click)="openHHAuthModal()"
              [disabled]="isLoading"
              class="action-button publish-button"
              icon="pi pi-send">
        {{ 'BUTTON.PUBLISH_TO_JOB_PLATFORMS' | translate }}
      </button>
    </div>
  }

  @if (error) {
    <div class="error-message">{{ error }}</div>
  }

  @if (generatedResume) {
    <div class="generated-resume">
      <markdown [data]="generatedResume" class="prose"></markdown>
    </div>
  }

  <p-dialog
    header="Публикация на HH.ru"
    [(visible)]="hhAuthModalVisible"
    [modal]="true"
    [style]="{ width: '50vw' }"
    [closable]="!isPublishing">

    @if (isPublishing) {
      <div class="publishing-section">
        <p-progressSpinner></p-progressSpinner>
        <p class="publishing-text">{{ 'RESUME_GENERATION.PUBLISHING' | translate }}</p>
      </div>
    }

    @if (publishStatus === 'success' && hhResumeUrl) {
      <div class="success-section">
        <p>{{ 'RESUME_GENERATION.PUBLISH_SUCCESS' | translate }}</p>
        <a [href]="hhResumeUrl" target="_blank">{{ 'RESUME_GENERATION.VIEW_ON_PLATFORMS' | translate }}</a>
      </div>
    }

    @if (publishStatus === 'error') {
      <div class="error-section">
        <p>{{ 'RESUME_GENERATION.PUBLISH_ERROR' | translate }}</p>
        <p>{{ 'RESUME_GENERATION.PUBLISH_ERROR_DETAIL' | translate }}</p>
      </div>
    }

    <ng-template pTemplate="footer" class="dialog-footer">
      @if (publishStatus === 'idle') {
        <button pButton
          label="Опубликовать"
          (click)="publishToHH()"
          [disabled]="isPublishing"></button>
      }
      <button pButton
        label="Закрыть"
        class="close-button"
        (click)="hhAuthModalVisible = false"
        [disabled]="isPublishing"></button>
    </ng-template>
  </p-dialog>
</div>

<app-vacancy-selector
  [(showSelector)]="showVacancySelector"
  (vacancySelected)="onVacancySelected($event)">
</app-vacancy-selector>