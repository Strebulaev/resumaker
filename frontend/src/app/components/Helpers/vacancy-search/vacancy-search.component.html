<div class="vacancy-search-container">
  <div class="search-header">
    <h2>{{ 'VACANCY.TITLE' | translate }}</h2>
    <p>{{ 'VACANCY.SUBTITLE' | translate }}</p>
  </div>

  <div class="section-navigation">
    <div class="nav-buttons">
      <button (click)="showSection('search')" [class]="['nav-button', activeSection === 'search' ? 'active' : '']">
        <i class="pi pi-search"></i>
        {{ 'VACANCY_SEARCH.TAB_SEARCH' | translate }}
      </button>
      <button (click)="showSection('favorites')" [class]="['nav-button', activeSection === 'favorites' ? 'active' : '']">
        <i class="pi pi-heart"></i>
        {{ 'VACANCY_SEARCH.TAB_FAVORITES' | translate }}
      </button>
    </div>
  </div>

  <!-- Секция поиска вакансий -->
  <div *ngIf="activeSection === 'search'" class="search-section">
    <div class="search-controls">
      <p-card [header]="'VACANCY.FILTERS' | translate" class="filters-card">
        <form [formGroup]="searchForm" (ngSubmit)="searchVacancies()">
          <div class="filters-grid">
            <div class="filter-group">
              <label>{{ 'SEARCH.KEYWORDS' | translate }}</label>
              <input type="text" pInputText formControlName="text" 
                     [placeholder]="'SEARCH.KEYWORDS_PLACEHOLDER' | translate">
            </div>

            <div class="filter-group">
              <label>{{ 'SEARCH.SALARY' | translate }}</label>
              <input type="number" pInputText formControlName="salary" 
                     [placeholder]="'SEARCH.SALARY_PLACEHOLDER' | translate">
            </div>

            <div class="filter-group">
              <label>{{ 'SEARCH.REGION' | translate }}</label>
              <input type="text" pInputText formControlName="area" 
                     [placeholder]="'SEARCH.REGION_PLACEHOLDER' | translate">
            </div>

            <div class="filter-group">
              <label>{{ 'SEARCH.EXPERIENCE' | translate }}</label>
              <p-select formControlName="experience" [options]="experienceOptions" 
                       optionLabel="label" optionValue="value"
                       [placeholder]="'SEARCH.EXPERIENCE_PLACEHOLDER' | translate">
              </p-select>
            </div>

            <div class="filter-group">
              <label>{{ 'SEARCH.EMPLOYMENT' | translate }}</label>
              <p-select formControlName="employment" [options]="employmentOptions" 
                       optionLabel="label" optionValue="value"
                       [placeholder]="'SEARCH.EMPLOYMENT_PLACEHOLDER' | translate">
              </p-select>
            </div>

            <div class="filter-group">
              <label>{{ 'SEARCH.SCHEDULE' | translate }}</label>
              <p-select formControlName="schedule" [options]="scheduleOptions" 
                       optionLabel="label" optionValue="value"
                       [placeholder]="'SEARCH.SCHEDULE_PLACEHOLDER' | translate">
              </p-select>
            </div>

            <div class="filter-group">
              <label>{{ 'SEARCH.PLATFORMS' | translate }}</label>
              <p-multiSelect formControlName="platforms" [options]="platformOptions" 
                            optionLabel="label" optionValue="value"
                            [placeholder]="'SEARCH.PLATFORMS_PLACEHOLDER' | translate">
              </p-multiSelect>
            </div>

            <div class="filter-group checkbox-group">
              <p-checkbox formControlName="only_with_salary" [binary]="true"
                         inputId="only_with_salary">
              </p-checkbox>
              <label for="only_with_salary" class="checkbox-label">
                {{ 'SEARCH.ONLY_WITH_SALARY' | translate }}
              </label>
            </div>

            <div class="filter-group checkbox-group">
              <p-checkbox formControlName="remote" [binary]="true"
                         inputId="remote">
              </p-checkbox>
              <label for="remote" class="checkbox-label">
                {{ 'SEARCH.REMOTE' | translate }}
              </label>
            </div>
          </div>

          <div class="search-actions">
            <button pButton type="submit" 
                    [label]="'SEARCH.SEARCH_BUTTON' | translate" 
                    [disabled]="isLoading"
                    icon="pi pi-search"
                    class="p-button-primary search-button">
            </button>

            <button pButton type="button" 
                    [label]="'SEARCH.RESET' | translate" 
                    (click)="resetFilters()"
                    icon="pi pi-refresh"
                    class="p-button-secondary">
            </button>
          </div>
        </form>
      </p-card>

      <p-card [header]="'VACANCY.QUICK_DOWNLOAD' | translate" class="quick-search-card">
        <div class="quick-actions">
          <button 
            pButton 
            [label]="'VACANCY_SELECTOR.TITLE' | translate" 
            icon="pi pi-briefcase"
            (click)="openVacancySelector()"
            class="p-button-help"
            style="margin-right: 0.5rem;">
          </button>
          
          <small class="url-hint">
            {{ 'VACANCY_SELECTOR.QUICK_LOAD_HINT' | translate }}
          </small>
        </div>
      </p-card>
    </div>

    <div class="results-section" *ngIf="vacancies.length > 0 || isLoading">
      <div class="results-header">
        <h3>
          {{ 'RESULTS.FOUND' | translate }}: 
          <span class="results-count">{{ vacancies.length }}</span>
        </h3>
        
        <div class="results-controls">
          <span class="sort-label">{{ 'RESULTS.SORT_BY' | translate }}:</span>
          <p-select [options]="sortOptions" optionLabel="label" optionValue="value"
                   formControlName="sortBy" (onChange)="sortVacancies()"
                   [placeholder]="'RESULTS.SORT_PLACEHOLDER' | translate"
                   style="margin-left: 0.5rem;">
          </p-select>
        </div>
      </div>

      <div class="vacancy-list">
        <div *ngFor="let vacancy of sortedVacancies" class="vacancy-card">
          <div class="vacancy-header">
            <div class="vacancy-title-section">
              <h4 class="vacancy-title">{{ vacancy.name }}</h4>
              <div class="vacancy-actions-top">
                <button pButton 
                        [icon]="vacancy.isFavorite ? 'pi pi-heart-fill' : 'pi pi-heart'" 
                        [class]="vacancy.isFavorite ? 'p-button-danger' : 'p-button-secondary'"
                        (click)="toggleFavorite(vacancy)"
                        class="p-button-sm"
                        [pTooltip]="vacancy.isFavorite ? 'Удалить из избранного' : 'Добавить в избранное'">
                </button>
              </div>
            </div>
            
            <div class="vacancy-salary" *ngIf="vacancy.salary">
              <span class="salary-amount">
                {{ getSalaryText(vacancy) }}
              </span>
              <span class="salary-currency">{{ vacancy.salary.currency }}</span>
            </div>
          </div>

          <div class="vacancy-platform" *ngIf="getVacancyPlatform(vacancy)">
            <span class="platform-badge" [class.hh-badge]="getVacancyPlatform(vacancy) === 'hh.ru'" 
                  [class.sj-badge]="getVacancyPlatform(vacancy) === 'superjob.ru'">
              <i class="pi pi-briefcase"></i>
              {{ getPlatformLabel(getVacancyPlatform(vacancy)) }}
            </span>
          </div>
          
          <div class="vacancy-company">
            <span class="company-name">{{ vacancy.employer.name }}</span>
            <span class="company-location" *ngIf="vacancy.address?.city">
              • {{ vacancy.address?.city }}
            </span>
          </div>

          <div class="vacancy-description">
            <p>{{ cleanHtml(vacancy.description.substring(0, 200) || '') }}...</p>
          </div>

          <div class="vacancy-meta">
            <span class="meta-item" *ngIf="vacancy.experience">
              <i class="pi pi-briefcase"></i>
              {{ vacancy.experience.name }}
            </span>
            
            <span class="meta-item" *ngIf="vacancy.employment">
              <i class="pi pi-clock"></i>
              {{ vacancy.employment.name }}
            </span>

            <span class="meta-item" *ngIf="vacancy.published_at">
              <i class="pi pi-calendar"></i>
              {{ formatDate(vacancy.published_at) }}
            </span>
          </div>

          <div class="vacancy-skills" *ngIf="vacancy.key_skills.length > 0">
            <div class="skills-label">{{ 'VACANCY.SKILLS' | translate }}:</div>
            <div class="skills-list">
              <span *ngFor="let skill of vacancy.key_skills.slice(0, 5)" 
                    class="skill-tag">
                {{ skill.name }}
              </span>
              <span *ngIf="vacancy.key_skills.length > 5" class="more-skills">
                +{{ vacancy.key_skills.length - 5 }} {{ 'VACANCY.MORE' | translate }}
              </span>
            </div>
          </div>

          <div class="vacancy-actions">
            <button pButton 
                    [label]="'DETAILS.VIEW' | translate" 
                    (click)="showVacancyDetails(vacancy)"
                    icon="pi pi-eye"
                    class="p-button-info">
            </button>
            
            <button pButton 
                    [label]="'VACANCY.EXPORT' | translate" 
                    (click)="exportVacancy(vacancy)"
                    icon="pi pi-download"
                    class="p-button-secondary">
            </button>
            
            <a *ngIf="vacancy.alternate_url" 
               [href]="vacancy.alternate_url" 
               target="_blank" 
               class="p-button p-button-outlined source-link">
              <i class="pi pi-external-link"></i>
              {{ 'DETAILS.VIEW_SOURCE' | translate }}
            </a>
          </div>
        </div>
      </div>

      <div class="pagination" *ngIf="totalPages > 1 && !isLoadingMore">
        <button pButton 
                [label]="'PAGINATION.PREVIOUS' | translate" 
                (click)="prevPage()"
                [disabled]="currentPage === 1"
                icon="pi pi-chevron-left"
                class="p-button-text">
        </button>
        
        <span class="page-info">
          {{ 'PAGINATION.PAGE' | translate }} {{ currentPage }} {{ 'PAGINATION.OF' | translate }} {{ totalPages }}
        </span>
        
        <button pButton 
                [label]="'PAGINATION.NEXT' | translate" 
                (click)="nextPage()"
                [disabled]="currentPage === totalPages"
                icon="pi pi-chevron-right"
                iconPos="right"
                class="p-button-text">
        </button>
      </div>

      <!-- Добавьте индикатор загрузки для бесконечной прокрутки -->
      <div *ngIf="isLoadingMore" class="loading-more">
        <p-progressSpinner [style]="{'width': '30px', 'height': '30px'}"></p-progressSpinner>
        <span>{{ 'LOADING.MORE_VACANCIES' | translate }}</span>
      </div>

      <!-- Добавьте триггер для бесконечной прокрутки -->
      <div #scrollTrigger class="scroll-trigger" *ngIf="hasMoreVacancies && !isLoadingMore"></div>
    </div>

    <div *ngIf="vacancies.length === 0 && !isLoading && searchPerformed" class="no-results">
      <div class="no-results-content">
        <i class="pi pi-search" style="font-size: 3rem; color: #6c757d;"></i>
        <h4>{{ 'RESULTS.NO_RESULTS' | translate }}</h4>
        <p>{{ 'RESULTS.NO_RESULTS_HINT' | translate }}</p>
        <button pButton 
                [label]="'SEARCH.RESET_FILTERS' | translate" 
                (click)="resetFilters()"
                icon="pi pi-refresh"
                class="p-button-outlined">
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="activeSection === 'favorites'" class="favorites-section">
    <div class="favorites-header">
      <h3>Избранные вакансии ({{ favoriteVacancies.length }})</h3>
      
      <div class="favorites-actions" *ngIf="favoriteVacancies.length > 0">
        <!-- Выбор резюме -->
        <div class="resume-selector">
          <label>Резюме для отправки:</label>
          <p-select 
            [options]="userResumes" 
            optionLabel="title"
            [(ngModel)]="selectedResume"
            [placeholder]="'Выберите резюме'"
            [ngModelOptions]="{standalone: true}"
            style="min-width: 200px; margin-left: 0.5rem;">
          </p-select>
        </div>

        <button pButton 
          label="Сгенерировать всё для всех"
          (click)="generateAllContent()"
          [disabled]="!selectedResume"
          icon="pi pi-bolt"
          class="p-button-success generate-all-button"
          style="margin-left: 1rem;">
          <p-progressSpinner *ngIf="!selectedResume" 
                          [style]="{'width': '20px', 'height': '20px'}" 
                          strokeWidth="4"
                          styleClass="ml-2">
          </p-progressSpinner>
        </button>
      </div>
    </div>

    <div class="favorites-grid" *ngIf="favoriteVacancies.length > 0">
      <app-favorite-vacancy-card
        *ngFor="let vacancy of favoriteVacancies"
        [vacancy]="vacancy"
        [selectedResume]="selectedResume"
        (generateCoverLetter)="generateCoverLetterForFavorite($event)"
        (generateDevelopmentPlan)="generateDevelopmentPlanForFavorite($event)"
        (generateResume)="generateResumeForFavorite($event)"
        (removeFromFavorites)="removeFromFavorites($event)"
        (sendCoverLetter)="sendCoverLetter($event)">
      </app-favorite-vacancy-card>
    </div>

    <!-- Сообщение об отсутствии избранных -->
    <div *ngIf="favoriteVacancies.length === 0" class="no-favorites">
      <div class="no-favorites-content">
        <i class="pi pi-heart" style="font-size: 3rem; color: #6c757d;"></i>
        <h4>Нет избранных вакансий</h4>
        <p>Добавьте вакансии в избранное, чтобы работать с ними</p>
      </div>
    </div>
  </div>

  <!-- Диалог деталей вакансии -->
  <p-dialog [header]="selectedVacancy?.name" 
           [visible]="showDetailsDialog" 
           (onHide)="closeDetailsDialog()"
           [modal]="true" 
           [style]="{ width: '60vw', maxHeight: '80vh' }"
           [breakpoints]="{ '960px': '75vw', '640px': '90vw' }">
    
    <div *ngIf="selectedVacancy" class="vacancy-details">
      <div class="detail-section">
        <h5>{{ 'DETAILS.COMPANY' | translate }}</h5>
        <p>{{ selectedVacancy.employer.name }}</p>
      </div>

      <div class="detail-section" *ngIf="selectedVacancy.salary">
        <h5>{{ 'DETAILS.SALARY' | translate }}</h5>
        <p>{{ getSalaryText(selectedVacancy) }} {{ selectedVacancy.salary.currency }}</p>
      </div>

      <div class="detail-section" *ngIf="selectedVacancy.address">
        <h5>{{ 'DETAILS.LOCATION' | translate }}</h5>
        <p>{{ getAddressText(selectedVacancy.address) }}</p>
      </div>

      <div class="detail-section">
        <h5>{{ 'DETAILS.DESCRIPTION' | translate }}</h5>
        <div class="description-content" [innerHTML]="formatDescription(selectedVacancy.description)"></div>
      </div>

      <div class="detail-section" *ngIf="selectedVacancy.key_skills.length > 0">
        <h5>{{ 'DETAILS.REQUIREMENTS' | translate }}</h5>
        <div class="skills-detail">
          <span *ngFor="let skill of selectedVacancy.key_skills" class="skill-tag large">
            {{ skill.name }}
          </span>
        </div>
      </div>
      
      <div class="detail-section" *ngIf="selectedVacancy">
        <h5>Платформа</h5>
        <div class="vacancy-platform">
          <span class="platform-badge" [class.hh-badge]="getVacancyPlatform(selectedVacancy) === 'hh.ru'" 
                [class.sj-badge]="getVacancyPlatform(selectedVacancy) === 'superjob.ru'">
            <i class="pi pi-briefcase"></i>
            {{ getPlatformLabel(getVacancyPlatform(selectedVacancy)) }}
          </span>
        </div>
      </div>

      <div class="detail-actions">
        <button pButton 
                [label]="'VACANCY.EXPORT' | translate" 
                (click)="exportVacancy(selectedVacancy)"
                icon="pi pi-download"
                class="p-button-primary">
        </button>
        
        <a *ngIf="selectedVacancy.alternate_url" 
           [href]="selectedVacancy.alternate_url" 
           target="_blank" 
           class="p-button p-button-outlined"
           style="margin-left: 0.5rem;">
          <i class="pi pi-external-link"></i>
          {{ 'DETAILS.VIEW_ORIGINAL' | translate }}
        </a>
      </div>
    </div>
  </p-dialog>

  <p-dialog [visible]="isLoading" [modal]="true" [closable]="false" [style]="{ width: '300px' }">
    <div class="loading-dialog">
      <p-progressSpinner></p-progressSpinner>
      <p>{{ 'LOADING.SEARCH' | translate }}</p>
    </div>
  </p-dialog>
</div>

<app-vacancy-selector
  [(showSelector)]="showVacancySelector"
  (vacancySelected)="onVacancySelected($event)">
</app-vacancy-selector>